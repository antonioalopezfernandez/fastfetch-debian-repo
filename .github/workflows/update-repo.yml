name: Actualizar Repositorio de Debian (firmado GPG)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *" # Todos los días a las 02:00 UTC

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v3

      - name: Instalar herramientas (dpkg-dev, apt-ftparchive, jq, curl, gpg)
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev apt-utils jq curl gnupg

      - name: Descargar la última release de Fastfetch (autenticada y robusta)
        id: get_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          API_URL="https://api.github.com/repos/fastfetch-cli/fastfetch/releases/latest"

          # Llamada autenticada para evitar rate limits
          HTTP_CODE=$(curl -sS -H "Authorization: Bearer $GH_TOKEN" \
                              -H "Accept: application/vnd.github+json" \
                              -H "User-Agent: gh-actions-fastfetch" \
                              -w "%{http_code}" -o /tmp/release.json "$API_URL")

          if [ "$HTTP_CODE" != "200" ]; then
            echo "Fallo al pedir la API (HTTP $HTTP_CODE):"
            cat /tmp/release.json || true
            exit 1
          fi

          LAST_VERSION=$(jq -r '.tag_name // empty' /tmp/release.json)
          if [ -z "${LAST_VERSION:-}" ]; then
            echo "La respuesta no contiene tag_name:"
            cat /tmp/release.json
            exit 1
          fi
          echo "Se encontró la versión más reciente: $LAST_VERSION"
          echo "LAST_VERSION=$LAST_VERSION" >> $GITHUB_ENV

          mkdir -p debs

          # Descarga directa de los .deb publicados por Fastfetch
          jq -r '.assets[].browser_download_url
                 | select(test("fastfetch-linux-(amd64|aarch64|armv6l|armv7l)\\.deb$"))' \
                 /tmp/release.json > /tmp/deb_urls.txt

          if [ ! -s /tmp/deb_urls.txt ]; then
            echo "No se encontraron .deb en la release $LAST_VERSION"
            exit 1
          fi

          while IFS= read -r url; do
            echo "Descargando $(basename "$url") ..."
            if ! curl -fL -o "debs/$(basename "$url")" "$url"; then
              echo "ADVERTENCIA: fallo al descargar $url"
              rm -f "debs/$(basename "$url")" || true
            fi
          done < /tmp/deb_urls.txt

          echo "Contenido de debs/:"
          ls -l debs || true

      - name: Importar clave GPG para firma
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          set -euo pipefail
          # Importa clave privada desde secreto ASCII-armored
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          # Evita prompt interactivo de passphrase
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          chmod 600 ~/.gnupg/gpg.conf
          # Obtiene el fingerprint de la primera clave secreta importada
          KEY_FP=$(gpg --list-secret-keys --with-colons | awk -F: '/^sec:/ {print $5; exit}')
          if [ -z "${KEY_FP:-}" ]; then
            echo "No se encontró clave GPG importada."
            exit 1
          fi
          echo "KEY_FP=$KEY_FP" >> $GITHUB_ENV

      - name: Crear y firmar el repositorio de Debian
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          set -euo pipefail
          cd debs

          # Genera Packages.gz a partir de los .deb presentes
          dpkg-scanpackages -m . /dev/null | gzip -9c > Packages.gz

          # Genera Release
          apt-ftparchive release . > Release

          # Firma separada (Release.gpg)
          gpg --batch --yes --pinentry-mode loopback \
              --passphrase "$GPG_PASSPHRASE" \
              -abs -o Release.gpg Release

          # Firma inline (InRelease)
          gpg --batch --yes --pinentry-mode loopback \
              --passphrase "$GPG_PASSPHRASE" \
              --clearsign -o InRelease Release

          # Exporta también la clave pública para que los clientes puedan importarla
          gpg --armor --export "$KEY_FP" > public.gpg

          echo "Archivos generados:"
          ls -l

      - name: Publicar en GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./debs
          publish_branch: gh-pages
          commit_message: "Actualizar a Fastfetch ${{ env.LAST_VERSION }} (repositorio firmado)"